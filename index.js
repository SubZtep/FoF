AFRAME.registerComponent("audio-listener",{init(){let e=this.el.sceneEl,t=e.audioListener||new THREE.AudioListener;e.audioListener=t,"suspended"===t.context.state?(["click","keypress"].forEach(e=>document.addEventListener(e,()=>{t.context.resume()},{once:!0})),t.context.addEventListener("statechange",this.contextActive.bind(this),{once:!0})):this.contextActive()},contextActive(){let e=this.el.sceneEl;e.addEventListener("camera-set-active",this.toCam.bind(this)),e.camera&&e.dispatchEvent(new CustomEvent("camera-set-active",{detail:{cameraEl:e.camera.el}}))},toCam(e){let t=this.el.sceneEl;e.detail.cameraEl.getObject3D("camera").add(t.audioListener),t.emit("audio-listener-active",t.audioListener)},remove(){this.el.sceneEl.removeEventListener("camera-set-active",this.toCam)}}),AFRAME.registerComponent("analyser",{dependencies:["pos-audio"],schema:{fftSize:{default:2048,oneOf:[32,64,128,256,512,1024,2048,4096,8192,16384,32768]},length:{type:"number",default:10},width:{type:"number",default:2},lag:{default:!1}},nextFFT(){this.el.setAttribute(this.attrName,{fftSize:Math.pow(2,Math.max((Math.log2(this.data.fftSize)+1)%16,5))})},init(){this.el.addEventListener("pos-audio-active",this.setup.bind(this))},setup({detail:e}){this.analyser=e.context.createAnalyser(),e.getOutput().connect(this.analyser),this.lineObj=new THREE.Line(new THREE.BufferGeometry,new THREE.LineBasicMaterial({color:"#ff0"})),this.el.setObject3D("line",this.lineObj),this.update({}),this.audio=e},update(e){!this.analyser||this.data.fftSize===e.fftSize&&this.data.length===e.length||(this.analyser.fftSize=this.data.fftSize,this.bufferLength=this.analyser.frequencyBinCount,this.sliceLength=this.data.length/this.bufferLength,this.tddata=new Float32Array(this.bufferLength),this.lineObj.geometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.bufferLength),3))),this.halfWidth=this.data.width/2},tick(e){if(!this.audio)return;if(this.data.lag){let t=Math.round(e/100);if(t===this.lastTime)return;this.lastTime=t}let{exe:t}=this.el.object3D.parent.userData,a=void 0!==t?t.value:0;0===a?this.tddata.fill(0):this.analyser.getFloatTimeDomainData(this.tddata),this.audio.gain.gain.setValueAtTime(a,0);let i,s=this.lineObj.geometry.attributes.position,n=s.array,r=0;for(i=0;i<this.bufferLength;i++)n[r++]=Math.random()/16-.04,n[r++]=this.tddata[i]*this.halfWidth,n[r++]=-this.sliceLength*i*a;s.needsUpdate=!0}}),AFRAME.registerComponent("oscillator",{dependencies:["pos-audio"],multiple:!0,schema:{frequency:{type:"number",default:440},detune:{type:"number",default:0},type:{default:"sine"},playSound:{default:!1}},init(){let e=this.el;e.addEventListener("pos-audio-active",this.setup.bind(this)),e.addEventListener("stateadded",({detail:e})=>{"exe"===e&&this.start()}),e.addEventListener("stateremoved",({detail:e})=>{"exe"===e&&this.stop()})},setup({detail:e}){this.audio=e},start(){this.audio&&(this.oscillator=this.audio.context.createOscillator(),this.oscillator.frequency.setValueAtTime(this.data.frequency,0),this.oscillator.detune.setValueAtTime(this.data.detune,0),this.audio.setNodeSource(this.oscillator),this.oscillator.start())},stop(){this.oscillator?.stop(),this.oscillator?.disconnect()}}),AFRAME.registerComponent("pos-audio",{init(){this.el.sceneEl.addEventListener("audio-listener-active",this.setup.bind(this))},setup({detail:e}){const t=new THREE.PositionalAudio(e);this.el.posAudio=t,this.el.emit("pos-audio-active",t)}});const e=(e,t)=>Math.random()*(e-t)+t,t=(e,t)=>{let a;for(a of e.faces)a.color.set(t)},a=(e,t,a,i,s)=>(s-i)*(e-t)/(a-t)+i,i=(i=0,s=0)=>{let n=new THREE.Geometry,r=e(7,9),o=i>0&&s>0?new THREE.TorusKnotGeometry(10,1.5,67,7,8,6).scale(.2,.1,.1).translate(0,r,0):new THREE.SphereGeometry(2,7,8).translate(0,r,0);t(o,i>0&&s>0?7086772:3161154),n.merge(o),((e,t)=>{e.vertices.forEach(e=>{e.x+=a(Math.random(),0,1,-t,t),e.y+=a(Math.random(),0,1,-t,t),e.z+=a(Math.random(),0,1,-t,t)})})(o,.2),((e,t)=>{e.vertices.forEach(e=>e.y=Math.max(e.y,t))})(o,-.5),o.computeFlatVertexNormals();let l=new THREE.CylinderGeometry(e(.1,.3),e(.2,.4),r,32).translate(0,r/2,0);return t(l,2236979),n.merge(l),n.translate(i,0,s),n},s=()=>new THREE.MeshPhongMaterial({vertexColors:!0,flatShading:!0});AFRAME.registerComponent("tree-simple",{init(){let e=new THREE.Mesh(i(),s());this.el.setObject3D("mesh",e)}});const n=(a=0,i=0)=>{let s=new THREE.Geometry,n=e(4,6),r=Array.from({length:n},()=>e(2,4));for(let e=0;e<n-2;e++){let a=new THREE.ConeGeometry(1.5+.5*e,r.pop(),8);t(a,39168),a.translate(0,r.reduce((e,t)=>e+t,0)-r.length,0),s.merge(a)}let o=new THREE.CylinderGeometry(.5,.5,r.pop());return t(o,724482),o.translate(0,0,0),s.merge(o),s.translate(a,0,i),s},r=()=>new THREE.MeshToonMaterial({color:"#d5ff80",vertexColors:!0});AFRAME.registerComponent("tree-pine",{init(){let e=new THREE.Mesh(n(),r());this.el.setObject3D("mesh",e)}}),AFRAME.registerComponent("ground",{schema:{size:{type:"number",default:100},playArea:{type:"number",default:.85},groundYScale:{type:"number",default:1.5},resolution:{type:"number",default:64}},update(){let e=this.getGeometry(this.data.size,this.data.resolution),t=new THREE.Mesh(e,this.getMaterial(this.data.size,!1));t.matrixAutoUpdate=!1,this.el.setObject3D("mesh",t),this.createWorker(e.vertices)},addBeach(){let e=this.data.size,t=new THREE.Shape;t.moveTo(0,0),t.lineTo(0,e),t.lineTo(e,e),t.lineTo(e,0),t.lineTo(0,0);let a=new THREE.ExtrudeGeometry(t,{steps:1,depth:1,bevelOffset:0,bevelThickness:1,bevelSize:10,bevelSegments:1}),i=new THREE.MeshToonMaterial({color:52224,wireframe:!1}),s=new THREE.Mesh(a,i);s.matrixAutoUpdate=!1,s.position.set(-e/2,-e/2,-2.1),s.updateMatrix(),this.el.setObject3D("beach",s)},createWorker(e){},getGeometry(e,t){let a=new THREE.PlaneGeometry(e,e,t,t),i=a.vertices,s=a.vertices.length,n=5/t,r=Math.sqrt(s);for(let e=0,t=0,a=0;e<s;e++){let o=this.random(e)<.35?this.random(e+1):0;o+=.1*this.random(e+2);let l=2*t/5-1,d=2*a/5-1;if(o*=l>d?l:d,o<.01&&(o=0),e<r||e>s-r-1)o=0;else{let t=e-r*Math.floor(e/r);0!==t&&t!==r-1||(o=0)}o>1&&(o=1),i[e].z=o,t+=n,t>=10&&(t=0,a+=n)}return a.computeFaceNormals(),a.computeVertexNormals(),a.verticesNeedUpdate=!0,a.normalsNeedUpdate=!0,a},getMaterial(e,t,a=2048,i=20){let s=e/i,n=document.createElement("canvas");n.width=a,n.height=a;let r=new THREE.Texture(n);r.wrapS=THREE.RepeatWrapping,r.wrapT=THREE.RepeatWrapping,r.repeat.set(s,s);let o=new THREE.MeshLambertMaterial({map:r,wireframe:t});return this.drawTexture(n.getContext("2d"),a),r.needsUpdate=!0,o},drawTexture(e,t,a="#499d45",i="#000"){let s,n,r,o,l,d;e.fillStyle=a,e.fillRect(0,0,t,t);let h=Math.floor(t/2),c=document.createElement("canvas");c.width=h,c.height=h;let u=c.getContext("2d");u.fillStyle=a,u.fillRect(0,0,h,h),d=u.getImageData(0,0,h,h),l=d.data,r=new THREE.Color(a),o=new THREE.Color(i);let m=[];for(s=0;s<1e3;s++)n=r.clone().lerp(o,Math.random()),m.push({x:Math.random()*h,y:Math.random()*h,r:Math.floor(255*n.r),g:Math.floor(255*n.g),b:Math.floor(255*n.b)});for(let e=0;e<6500;e++)for(s=0;s<1e3;s++){let e=m[s],t=4*Math.floor(e.y*h+e.x);l[t+0]=e.r,l[t+1]=e.g,l[t+2]=e.b,e.x+=Math.floor(3*Math.random())-1,e.y+=Math.floor(3*Math.random())-1,e.x>=h&&(e.x=e.x-h),e.y>=h&&(e.y=e.y-h),e.x<0&&(e.x=h+e.x),e.y<0&&(e.y=h+e.y)}u.putImageData(d,0,0),e.drawImage(c,0,0,t,t)},random:(e,t=8)=>parseFloat("0."+Math.sin(9999*t*e).toString().substr(7))}),AFRAME.registerComponent("forest",{schema:{treeCount:{type:"int",default:100},emptyWidth:{type:"number",default:10},forestWidth:{type:"number",default:40}},init(){const e=(e,t=8)=>parseFloat("0."+Math.sin(9999*t*e).toString().substr(7));let t=new THREE.Geometry,a=new THREE.Geometry;for(let s=0,r=88343;s<this.data.treeCount;s++,r++){let s=this.data.emptyWidth+this.data.forestWidth*e(r+1),o=e(r+3)*Math.PI*2,l=Math.cos(o)*s,d=Math.sin(o)*s;l<0&&d<0?a.merge(n(l,d)):t.merge(i(l,d))}this.el.setObject3D("oaks",new THREE.Mesh(t,s())),this.el.setObject3D("pines",new THREE.Mesh(a,r())),this.el.object3D.matrixAutoUpdate=!1}}),AFRAME.registerComponent("water",{schema:{size:{type:"vec2",default:{x:100,y:30}}},init(){const e=new THREE.MeshPhongMaterial({color:2263295,shininess:100});e.onBeforeCompile=e=>{e.uniforms.time={value:0},e.vertexShader="\n          uniform float time;\n      "+e.vertexShader;e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n          vec3 transformed = vec3(position);\n          float freq = 3.0;\n          float amp = 0.1;\n          float angle = (time + position.x)*freq;\n          transformed.z += sin(angle)*amp;\n      "),this.matShader=e};const t=new THREE.Mesh(new THREE.PlaneBufferGeometry(this.data.size.x,this.data.size.y,1,1),e);t.rotation.x=-90*Math.PI/180,this.el.setObject3D("mesh",t)}}),AFRAME.registerComponent("obstacle-stop",{dependencies:["raycaster"],schema:{player:{type:"selector",default:"#player"}},init(){this.data.player.hasLoaded?this.addControls():this.data.player.addEventListener("loaded",this.addControls.bind(this),{once:!0})},addControls(){this.wasd=this.data.player.components["wasd-controls"];let e=this.wasd.getMovementVector,t=()=>new THREE.Vector3;this.el.addEventListener("raycaster-intersection",()=>{this.wasd.getMovementVector=t}),this.el.addEventListener("raycaster-intersection-cleared",()=>{this.wasd.getMovementVector=e})},tick(){let e=this.wasd.velocity;if(0!==e.x||0!==e.z){let t=e.clone().normalize().divideScalar(4),a=t.clone().divideScalar(2);a.y=2,this.el.setAttribute("raycaster",{origin:t,direction:a})}}}),AFRAME.registerComponent("wasd-ext",{dependencies:["wasd-controls"],schema:{rotate:{default:.001},avatar:{type:"selector",default:"#avatar"}},rotate:0,camUp:!1,init(){this.el.sceneEl.addEventListener("enter-vr",this.pause.bind(this)),this.el.sceneEl.addEventListener("exit-vr",this.play.bind(this))},play(){window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this))},pause(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp),this.cam(!1)},cam(e){this.el.sceneEl.camera.el.emit(e?"u":"d"),setTimeout(()=>{this.data.avatar.setAttribute("visible",e),this.el.children[0].setAttribute("raycaster","showLine",e)},200)},onKeyDown({key:e}){"q"===e?this.rotate=1:"e"===e?this.rotate=-1:"c"===e&&(this.camUp=!this.camUp,this.cam(this.camUp))},onKeyUp({key:e}){"q"!==e&&"e"!==e||(this.rotate=0)},tick(e,t){0!==this.rotate&&(this.el.object3D.rotation.y+=this.data.rotate*this.rotate*t)}}),AFRAME.registerComponent("wasd-vr",{schema:{action:{default:"move"},velocity:{default:120},run:{default:2},turn:{default:Math.PI/5},player:{type:"selector",default:"#player"}},init(){this.el.sceneEl.addEventListener("enter-vr",this.addControls.bind(this),{once:!0})},move(e,t){let a={};t<0?a.KeyW=1:t>0&&(a.KeyS=1),e<0?a.KeyA=1:e>0&&(a.KeyD=1),this.wasd.data.acceleration=Math.max(Math.abs(t),Math.abs(e))*(this.data.velocity*(this.el.is("run")?this.data.run:1)),this.wasd.keys=a},turn(e){let t=Math.sign(e);t!==this.lastTurn&&(this.lastTurn=t,this.data.player.object3D.rotation.y-=t*this.data.turn)},addControls(){let e=this.el;this.wasd=this.data.player.components["wasd-controls"],e.addEventListener("buttonchanged",({detail:t})=>{let a,i=t.state.pressed?"addState":"removeState";switch(this.mapping().buttons[t.id]){case"thumbstick":a="run";break;case"grip":a="hold";break;case"trigger":a="exe",e.object3D.userData.exe=t.state}e[i](a)}),e.addEventListener("axismove",({detail:e})=>{let[t,a]=Object.values(this.mapping().axes)[0],{axis:i}=e;this[this.data.action](i[t],i[a])}),e.setAttribute("raycaster",{enabled:!0})},mapping(){let{id:e,hand:t}=this.el.components["tracked-controls"].data;return this.el.components[e+"-controls"].mapping[t]}}),AFRAME.registerComponent("hand-vr",{dependencies:["raycaster"],schema:{player:{type:"selector",default:"#player"}},intersections:[],uuids:[],init(){this.raycaster=this.el.components.raycaster},play(){let e=this.el;e.addEventListener("raycaster-intersection",()=>this.intersections=this.raycaster.intersections),e.addEventListener("raycaster-intersection-cleared",()=>this.intersections=[]),e.addEventListener("stateadded",({detail:t})=>{switch(t){case"hold":let t;for(t of this.intersections){let a=t.object.parent.parent.el.object3D;this.uuids.push(a.uuid),e.object3D.attach(a),a.children[0].el.emit("hand",!0)}break;case"exe":let a;for(a of e.object3D.children)this.uuids.includes(a.uuid)&&a.el.addState("exe")}}),e.addEventListener("stateremoved",({detail:t})=>{switch(t){case"hold":let t=this.uuids.length;for(;t--;){let a=e.object3D.children.find(e=>e.uuid===this.uuids[t]);a&&(this.uuids.splice(t,1),e.sceneEl.object3D.attach(a),a.children[0].el.emit("hand",!1))}break;case"exe":let a;for(a of e.object3D.children)this.uuids.includes(a.uuid)&&a.el.removeState("exe")}})}}),AFRAME.registerComponent("cursor-listener",{init:function(){let e=-1,t=["red","green","blue"];this.el.addEventListener("click",(function(a){console.log(a),e=(e+1)%t.length,this.setAttribute("material","color",t[e]),console.log("I was clicked at: ",a.detail.intersection.point)}))}}),AFRAME.registerComponent("skypox",{init(){for(var e=new THREE.Geometry,t=0;t<1e3;t++){var a=new THREE.Vector3,i=THREE.Math.randFloatSpread(360),s=THREE.Math.randFloatSpread(360);a.x=100*Math.sin(i)*Math.cos(s),a.y=100*Math.sin(i)*Math.sin(s),a.z=100*Math.cos(i),e.vertices.push(a)}var n=new THREE.Points(e,new THREE.PointsMaterial({color:14329120,size:3,sizeAttenuation:!1}));n.boundingSphere=120,this.el.sceneEl.object3D.add(n)}}),AFRAME.registerComponent("intro",{async init(){await(async(e,t)=>{const a=await fetch(`entities/${e}.html`);t.insertAdjacentHTML("beforeend",await a.text())})("intro",this.el),this.el.setAttribute("background","color: #000"),this.end=0,["l","r"].forEach(e=>{let t=document.querySelector("#"+e);t.addEventListener("thumbstickdown",()=>{this.end++,2===this.end&&(this.el.setAttribute("animation","property: background.color; type: color; to: #24b5af; easing: easeInOutQuint; dur: 10000"),setTimeout(()=>{document.querySelectorAll(".intro").forEach(e=>{e.parentNode.removeChild(e)})},5e3),this.el.sceneEl.addState("forest"))}),t.addEventListener("thumbstickup",()=>{this.end--})})},remove(){document.querySelectorAll(".intro").forEach(e=>{e.parentNode.removeChild(e)}),this.el.setAttribute("background","color: #24b5af")}}),AFRAME.registerComponent("handy",{hands:{left:0,right:0},init(){let e=this.el;const t=()=>{e.is("hold")?(e.object3D.scale.set(1,1,1),e.removeAttribute("mixin")):e.setAttribute("mixin","pulse"+(e.is("intersect")?" fastanim":""))};e.addEventListener("raycaster-intersected",t=>{let a=t.detail.el.components["hand-controls"];a&&(this.hands[a.data.hand]=1,e.addState("intersect"))}),e.addEventListener("raycaster-intersected-cleared",({detail:t})=>{let a=t.el.components["hand-controls"];a&&(this.hands[a.data.hand]=0,0===this.hands.left&&0===this.hands.right&&e.removeState("intersect"))}),e.addEventListener("hand",({detail:t})=>{t?e.addState("hold"):e.removeState("hold")}),e.addEventListener("stateadded",t),e.addEventListener("stateremoved",t),t()}}),AFRAME.registerSystem("storyline",{dependencies:["ground"],init(){this.el.addEventListener("enter-vr",async()=>{this.el.addState("forest")},{once:!0}),this.el.addEventListener("exit-vr",()=>{console.log("EXIT VR")}),this.el.addEventListener("stateadded",e=>{switch(e.detail){case"intro":this.el.setAttribute("intro","")}}),this.el.addState("forest")}});const o=new THREE.MeshLambertMaterial({vertexColors:!0});var l=new THREE.Mesh((()=>{let e=new THREE.Color("#1da1f2"),a=new THREE.Color("#ffff00"),i=new THREE.Geometry,s=new THREE.SphereGeometry(1,8,8).translate(0,1.4,0);t(s,e),i.merge(s);let n=new THREE.SphereGeometry(.75,8,8).scale(.75,.75,.75).translate(0,2.8,.33);t(n,e),i.merge(n);let r=new THREE.ConeGeometry(1,2,8).rotateX(Math.PI/1.6).scale(.42,.42,.42).translate(0,2.6,.8);t(r,a),console.log(r),i.merge(r);let o=new THREE.CylinderGeometry(.9,1,.1).rotateX(48).rotateY(8).rotateZ(17).scale(.2,.68,.5).translate(-1.1,1.45,-.2);t(o,e),i.merge(o);let l=new THREE.CylinderGeometry(.9,1,.1).rotateX(48).rotateY(-8).rotateZ(-17).scale(.2,.68,.5).translate(1.1,1.45,-.2);return t(l,e),i.merge(l),i.scale(.15,.15,.15),i})(),o);AFRAME.registerSystem("zoo",{init(){let e=document.createElement("a-entity");e.setAttribute("oscillator",""),e.setAttribute("oscillator__a","frequency: 110"),e.setAttribute("analyser","lag: true");let t=document.createElement("a-entity");t.setObject3D("bird",l.rotateY(Math.PI).translateY(-.37)),t.setAttribute("handy",""),e.appendChild(t);document.createElement("a-entity");e.object3D.position.set(0,1.6,-4),e.object3D.rotateY(Math.PI/2),this.sceneEl.appendChild(e)}});
